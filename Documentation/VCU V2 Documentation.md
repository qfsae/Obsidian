# Version 2 Iteration of the Vehicle Control Unit

See [[VCU V2]] for the changelog

## Technical Notes
The VCU consists of 3 components that can be split into 9 subsections: Sensor Input, Debug Output, and Power Distribution. 
Sensory input consists of the digital and analogue inputs across all voltage ranges. 
Debug output consists of two seven segment displays and four LEDs. Debug outputs are connected directly to MCU GPIO pins with the intention that they can be used with the most basic level of code.  
Power distribution consists of the voltage regulation units, load switches, and PWM controlled high power outputs.

### Sensory Inputs
The VCU features 6 12V analogue inputs, 4 5V analogue inputs, and 4 12V digital inputs.
Digital inputs are rated for 12V and go through a 60.4/100 k Ohm voltage divider. 12V analogue inputs go through the same voltage divider but also feature a 0.1uF capacitor to reduce input impedance to the STM32's ADCs.
5V analogue inputs use a 60.4/22 k Ohm voltage divider and a 0.1uF capacitor similar to the 12V analogue inputs.

Digital sensory inputs are connected to STM32 Timer pins. The intention is that they can be used to measure the PWM signals generated by the wheel speed sensors.

### Debug Outputs
The board has several debug outputs from USART COMM ports and SWD to LED indicators.

#### COMM Ports
Four USART COMM ports are exposed. The design intention is for USART 2 to be used as a primary debug port, with `printf` calls being forwarded through it, while the other three USART ports (3, 5, 6) are used for task specific information and live data for test bench tuning.
Ports Available:
- USART 2
- USART 3
- UART 5
- USART 6

The board also features Serial Wire Debug (SWD) for on chip debugging and flashing firmware.

#### LED Indication
The board has two sources of LED indication. The first source is four multicolored LEDs placed next to the STM32 Microcontroller. These LEDs can be used for any purpose like debugging or error indication.

The board also features two seven segment displays controlled by CD4511 binary counters. The seven segment displays will display the binary number given to the CD4511's. The CD4511's are controlled directly through GPIO pins.
The intended purpose behind the displays is to cycle through possible errors and allow for at a glance error diagnosis. The displays can also be used to display any two digit number between 0 and 99.


### Power Outputs
Power distribution is split into 4 voltage rails with 3 of the rails feeding off of the boards centralized power and the high current rail having its own power input.

#### Fusing
The board has 7 automotive fuses carrying the dual purpose of overcurrent protection and isolation between voltage rails.
Fuses are placed on both the high and low sides of the voltage regulators.
Fuses are also placed in between the MOSFETS and the connectors for the coolant pump outputs.
A single fuse with a maximum rating of 40A is also placed near the board power inputs.

#### Power Rails
The board has a 12V and a 5V rail that feed off of the 24V battery power. Each rail is powered by a buck converter capable of carrying a maximum current of 20A.
*Note: The 12V and 5V Rails are always on, the 24V rail requires and enable*

#### Load Switches
All load switches are rated to a maximum current of 3A. Each load switch has an LED placed on its enable line. The LEDs are placed near the output connector for said load switch. There are 6 load switches for the 5V and 12V rails and 8 switches for the 24V rail.
All load switches are controlled via shift registers. Shift registers are loaded through the SPI2 interface and store the loaded value once the latch line has been pulsed.

### EEPROM
*Note:* The EPROM currently selected is an STM EEPROM soldered onto the board. It will be exchanged for a suitable DIP package before the design is manufactured.

### Onboard References
ADC inputs 0, 1, and 13 are used to sense the 24V, 12V, and 5V rails. Several INA219 voltage and current sensors are also placed on the board to monitor the power usage of the power rails as well as for closed loop control on the coolant pumps.